name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  FORCE_COLOR: "1"

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Lint: Check code style and formatting
  # ─────────────────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Check code style (ruff check)
        run: uv run ruff check tests/

      - name: Check formatting (ruff format)
        run: uv run ruff format --check tests/

  # ─────────────────────────────────────────────────────────────────────────
  # Type Check: Static type analysis with mypy
  # ─────────────────────────────────────────────────────────────────────────
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run mypy
        # Skip strict checking for now - existing tools have type issues
        # Once tools are typed, remove --disable-error-code flags
        run: |
          uv run mypy tests/ \
            --ignore-missing-imports \
            --no-error-summary \
            --disable-error-code=import-untyped \
            || echo "Type checking has warnings (non-blocking for now)"

  # ─────────────────────────────────────────────────────────────────────────
  # Test: Run pytest on multiple Python versions
  # ─────────────────────────────────────────────────────────────────────────
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Setup Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --extra dev --python ${{ matrix.python-version }}

      - name: Run tests with coverage
        run: |
          uv run --python ${{ matrix.python-version }} pytest \
            --cov=tools \
            --cov-report=term-missing \
            --cov-report=xml

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

  # ─────────────────────────────────────────────────────────────────────────
  # Frontend: Lint and build the Next.js dashboard
  # ─────────────────────────────────────────────────────────────────────────
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: tools/dashboard/frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: tools/dashboard/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Build application
        run: npm run build

      # Uncomment when Vitest is configured
      # - name: Run tests
      #   run: npm test

  # ─────────────────────────────────────────────────────────────────────────
  # Summary: Require all jobs to pass
  # ─────────────────────────────────────────────────────────────────────────
  ci-success:
    name: CI Success
    needs: [lint, typecheck, test, frontend]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs passed
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TYPECHECK_RESULT: ${{ needs.typecheck.result }}
          TEST_RESULT: ${{ needs.test.result }}
          FRONTEND_RESULT: ${{ needs.frontend.result }}
        run: |
          if [[ "$LINT_RESULT" != "success" ]] || \
             [[ "$TYPECHECK_RESULT" != "success" ]] || \
             [[ "$TEST_RESULT" != "success" ]] || \
             [[ "$FRONTEND_RESULT" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI jobs passed!"

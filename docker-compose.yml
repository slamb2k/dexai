# =============================================================================
# DexAI Docker Compose Configuration
# =============================================================================
# Usage:
#   docker compose up -d                       # Start core services
#   docker compose --profile proxy up -d       # Start with Caddy reverse proxy
#   docker compose --profile tailscale up -d   # Start with Tailscale VPN
#   docker compose logs -f                     # Follow logs
#   docker compose down                        # Stop all services
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend: FastAPI Python Service
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dexai-backend
    restart: unless-stopped
    mem_limit: 4g
    ports:
      - "${DEXAI_BACKEND_PORT:-8080}:8080"
    environment:
      - PYTHONPATH=/app
      - DEXAI_ENV=production
    env_file:
      - .env
    volumes:
      # Persist SQLite databases
      - dexai-data:/app/data
      # Mount args for runtime configuration (writable for setup wizard)
      - ./args:/app/args
      # Mount memory for persistent storage
      - ./memory:/app/memory
      # Note: .claude/skills/ is baked into the image (built-in skills, read-only)
      # User-created skills go in workspace: /app/data/workspaces/{user}/.claude/skills/
      # Uncomment the line below to enable container-based execution isolation (V-10/S-4).
      # Requires DEXAI_CONTAINER_ISOLATION=true in .env.
      # WARNING: Grants the backend the ability to manage Docker containers.
      # - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8080/api/health', timeout=5).raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - dexai-network

  # ---------------------------------------------------------------------------
  # Frontend: Next.js Dashboard
  # ---------------------------------------------------------------------------
  # NEXT_PUBLIC_API_URL options (baked in at BUILD time):
  #   - Empty (default): Uses relative URLs - works with Caddy proxy
  #   - http://localhost:8080: Direct backend access (local dev without proxy)
  #   - http://your-machine:8080: Direct backend access (remote without proxy)
  frontend:
    build:
      context: ./tools/dashboard/frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-}
    container_name: dexai-frontend
    restart: unless-stopped
    mem_limit: 8g
    ports:
      - "${DEXAI_FRONTEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=4096
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      # Use 127.0.0.1 instead of localhost to avoid IPv6 ::1 resolution issues
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - dexai-network

  # ---------------------------------------------------------------------------
  # Caddy: Reverse Proxy with Automatic HTTPS
  # ---------------------------------------------------------------------------
  caddy:
    image: caddy:2-alpine
    container_name: dexai-caddy
    restart: unless-stopped
    profiles:
      - proxy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    environment:
      - DEXAI_DOMAIN=${DEXAI_DOMAIN:-localhost}
      - DEXAI_ADMIN_EMAIL=${DEXAI_ADMIN_EMAIL:-admin@example.com}
      - CADDY_TLS_MODE=${CADDY_TLS_MODE:-local_certs}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      - caddy-logs:/var/log/caddy
    depends_on:
      - backend
      - frontend
    networks:
      - dexai-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8888/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ---------------------------------------------------------------------------
  # Tailscale: Secure Zero-Config VPN
  # ---------------------------------------------------------------------------
  tailscale:
    image: tailscale/tailscale:latest
    container_name: dexai-tailscale
    hostname: ${TAILSCALE_HOSTNAME:-dexai}
    restart: unless-stopped
    profiles:
      - tailscale
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTHKEY:-}
      - TS_HOSTNAME=${TAILSCALE_HOSTNAME:-dexai}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_SERVE_CONFIG=/config/tailscale-serve.json
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./deploy/tailscale:/config:ro
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      - dexai-network
    depends_on:
      - backend

# =============================================================================
# Volumes
# =============================================================================
volumes:
  dexai-data:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
  caddy-logs:
    driver: local
  tailscale-state:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  dexai-network:
    driver: bridge

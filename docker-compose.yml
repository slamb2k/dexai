# =============================================================================
# DexAI Docker Compose Configuration
# =============================================================================
# Usage:
#   docker compose up -d              # Start all services
#   docker compose up -d backend      # Start only backend
#   docker compose logs -f            # Follow logs
#   docker compose down               # Stop all services
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend: FastAPI Python Service
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dexai-backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - PYTHONPATH=/app
      - DEXAI_ENV=production
    env_file:
      - .env
    volumes:
      # Persist SQLite databases
      - dexai-data:/app/data
      # Mount args for runtime configuration
      - ./args:/app/args:ro
      # Mount memory for persistent storage
      - ./memory:/app/memory
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8080/api/health', timeout=5).raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - dexai-network

  # ---------------------------------------------------------------------------
  # Frontend: Next.js Dashboard
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./tools/dashboard/frontend
      dockerfile: Dockerfile
    container_name: dexai-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend:8080
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - dexai-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  dexai-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  dexai-network:
    driver: bridge
